<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Farewell Album</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
    body {
        background: #eef4ff;
        padding: 25px;
        font-family: "Segoe UI", Arial, sans-serif;
    }
    h1 {
        text-align: center;
        font-size: 32px;
        margin-bottom: 30px;
        color: #003f88;
    }
    .card {
        background: #ffffff;
        border-radius: 14px;
        padding: 22px;
        margin-bottom: 28px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    .name {
        font-size: 22px;
        font-weight: 600;
        color: #003f88;
        text-align: center;
        margin-top: 15px;
    }
    .role, .msg {
        text-align: center;
        font-size: 15px;
        color: #444;
    }
    .msg {
        margin-top: 5px;
    }
    .carousel-inner img {
        height: 400px;
        width: 100%;
        object-fit: cover;
        border-radius: 10px;
        background: #eaeaea;
    }
    .loading {
        font-size: 14px;
        color: #777;
        padding: 10px 0;
    }
</style>
</head>
<body>

<h1>Farewell Album</h1>

<div id="albumContainer">Loading album...</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// === CONFIG ===
const SHEET_ID = "17fX959sLNO6mXrTqAdu0lVeGpzwwXZ9-FSicu24BgU0";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
const DRIVE_API_KEY = "AIzaSyBKZSium0piyKAQovFTOkePJ6-wdxkgaBM";
// ===============

// Extract folder ID from any Drive link
function getFolderId(url) {
    if (!url) return "";
    url = url.trim();

    let m = url.match(/\/folders\/([a-zA-Z0-9_-]+)/);
    if (m) return m[1];

    m = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
    if (m) return m[1];

    if (/^[a-zA-Z0-9_-]+$/.test(url)) return url;

    return "";
}

// Fetch image file list from Drive folder
async function getImages(folderId) {
    const query = encodeURIComponent(`'${folderId}' in parents and mimeType contains 'image/'`);
    const url = `https://www.googleapis.com/drive/v3/files?q=${query}&fields=files(id,name)&key=${DRIVE_API_KEY}`;

    try {
        const resp = await fetch(url);
        const data = await resp.json();

        if (!data.files) return [];

        return data.files.map(file => ({
            id: file.id,
            url: `https://lh3.googleusercontent.com/d/${file.id}=w2000`
        }));

    } catch (e) {
        console.error("Drive API error:", e);
        return [];
    }
}

// Build Bootstrap Image Carousel — AUTOPLAY ENABLED
function buildCarousel(images, cid) {
    if (images.length === 0) {
        return `<div class="loading">No photos found in folder.</div>`;
    }

    let slides = "";
    let indicators = "";

    images.forEach((img, index) => {
        slides += `
        <div class="carousel-item ${index === 0 ? "active" : ""}">
            <img src="${img.url}" alt="Photo">
        </div>`;
        indicators += `
        <button type="button" data-bs-target="#${cid}" data-bs-slide-to="${index}"
                class="${index===0?"active":""}"></button>`;
    });

    return `
    <div id="${cid}" 
         class="carousel slide carousel-fade"
         data-bs-ride="carousel"
         data-bs-interval="3000"
         data-bs-pause="false"
         data-bs-touch="false">

        <div class="carousel-indicators">${indicators}</div>
        <div class="carousel-inner">${slides}</div>

        <button class="carousel-control-prev" type="button" data-bs-target="#${cid}" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
        </button>

        <button class="carousel-control-next" type="button" data-bs-target="#${cid}" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
        </button>
    </div>`;
}


// Load Sheet → Build Album
async function loadAlbum() {
    const container = document.getElementById("albumContainer");

    const resp = await fetch(SHEET_URL);
    const text = await resp.text();
    const json = JSON.parse(text.substr(47).slice(0, -2));

    const rows = json.table.rows;
    container.innerHTML = "";

    for (let i = 0; i < rows.length; i++) {
        const r = rows[i];

        const name = r.c[0]?.v || "";
        const role = r.c[1]?.v || "";
        const msg  = r.c[2]?.v || "";
        const folderLink = r.c[3]?.v || "";

        const folderId = getFolderId(folderLink);
        const carouselId = `carousel_${i}`;

        // Officer details now BELOW the carousel
        container.innerHTML += `
        <div class="card">
            <div id="${carouselId}_box" class="mb-3">
                <div class="loading">Loading photos...</div>
            </div>

            <div class="name">${name}</div>
            <div class="role">${role}</div>
            <div class="msg">${msg}</div>
        </div>`;

        if (folderId) {
            const images = await getImages(folderId);
            document.getElementById(`${carouselId}_box`).innerHTML = buildCarousel(images, carouselId);
        }
    }
}

loadAlbum();
</script>

</body>
</html>
