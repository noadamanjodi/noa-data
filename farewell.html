<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Farewell Album</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
    body {
        background: #eef4ff;
        padding: 25px;
        font-family: "Segoe UI", Arial, sans-serif;
    }

    h1 {
        text-align: center;
        font-size: 32px;
        margin-bottom: 25px;
        color: #003f88;
        font-weight: 700;
    }

    .search-box {
        max-width: 500px;
        margin: 0 auto 25px auto;
    }

    .card {
        background: #ffffff;
        border-radius: 14px;
        padding: 22px;
        margin-bottom: 32px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .name {
        font-size: 26px;
        font-weight: 700;
        text-align: center;
        color: #003f88;
        margin-top: 15px;
    }

    .role {
        text-align: center;
        font-size: 16px;
        font-weight: 500;
        color: #444;
    }

    .msg {
        text-align: center;
        margin-top: 10px;
        font-size: 15px;
        color: #333;
    }

    .featured-img {
        width: 100%;
        height: 380px;
        object-fit: cover;
        border-radius: 12px;
        margin-bottom: 18px;
    }

    .carousel-inner img {
        width: 100%;
        height: 360px;
        object-fit: cover;
        border-radius: 10px;
    }

    .carousel-caption {
        background: rgba(0,0,0,0.55);
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 14px;
    }

    .gallery {
        margin-top: 15px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 12px;
    }

    .gallery img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.2s ease;
    }

    .gallery img:hover {
        transform: scale(1.05);
    }

    /* Fade animation */
    .carousel-item {
        transition: opacity 1s ease-in-out;
    }

    .loading {
        font-size: 14px;
        color: #777;
        padding: 10px 0;
    }
</style>
</head>
<body>

<h1>Farewell Album</h1>

<!-- SEARCH BAR -->
<div class="search-box">
    <input id="search" class="form-control form-control-lg" type="text" placeholder="Search officer name..." onkeyup="filterCards()">
</div>

<div id="albumContainer">Loading album...</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// === CONFIG ===
const SHEET_ID = "17fX959sLNO6mXrTqAdu0lVeGpzwwXZ9-FSicu24BgU0";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
const DRIVE_API_KEY = "AIzaSyBKZSium0piyKAQovFTOkePJ6-wdxkgaBM";
// ===============================================

// Extract folder ID
function getFolderId(url) {
    if (!url) return "";
    url = url.trim();
    let m = url.match(/\/folders\/([a-zA-Z0-9_-]+)/);
    if (m) return m[1];
    m = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
    if (m) return m[1];
    if (/^[a-zA-Z0-9_-]+$/.test(url)) return url;
    return "";
}

// Fetch images from Drive
async function getImages(folderId) {
    const q = encodeURIComponent(`'${folderId}' in parents and mimeType contains 'image/'`);
    const url = `https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name)&key=${DRIVE_API_KEY}`;

    try {
        const resp = await fetch(url);
        const data = await resp.json();
        if (!data.files) return [];

        return data.files.map(f => ({
            id: f.id,
            name: f.name,
            url: `https://lh3.googleusercontent.com/d/${f.id}=w2000`
        }));

    } catch (e) {
        console.error(e);
        return [];
    }
}

// Build carousel with autoplay + fade + captions
function buildCarousel(images, cid) {
    if (images.length === 0) return "";

    let slides = "";
    let indicators = "";

    images.forEach((img, i) => {
        slides += `
        <div class="carousel-item ${i === 0 ? "active" : ""}">
            <img src="${img.url}" class="d-block w-100">
            <div class="carousel-caption">
                ${img.name}
            </div>
        </div>`;

        indicators += `
        <button type="button" data-bs-target="#${cid}" data-bs-slide-to="${i}" class="${i===0?"active":""}"></button>`;
    });

    return `
    <div id="${cid}" class="carousel slide carousel-fade" data-bs-ride="carousel" data-bs-interval="3000">
        <div class="carousel-indicators">${indicators}</div>
        <div class="carousel-inner">${slides}</div>

        <button class="carousel-control-prev" type="button" data-bs-target="#${cid}" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
        </button>

        <button class="carousel-control-next" type="button" data-bs-target="#${cid}" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
        </button>
    </div>`;
}

// ===============================================
// LOAD THE ALBUM
// ===============================================
async function loadAlbum() {
    const res = await fetch(SHEET_URL);
    const text = await res.text();
    const json = JSON.parse(text.substr(47).slice(0, -2));
    const rows = json.table.rows;

    const container = document.getElementById("albumContainer");
    container.innerHTML = "";

    for (let i = 1; i < rows.length; i++) { // SKIP HEADER ROW (i = 1)
        const r = rows[i];

        const name = r.c[0]?.v || "";
        const role = r.c[1]?.v || "";
        const msg = r.c[2]?.v || "";
        const folderLink = r.c[3]?.v || "";
        const folderId = getFolderId(folderLink);

        const cardId = "person_" + i;
        const carouselId = "carousel_" + i;

        container.innerHTML += `
        <div class="card person-card" data-name="${name.toLowerCase()}">
            <div id="${cardId}">
                <div class="loading">Loading photos...</div>
            </div>
            <div class="name">${name}</div>
            <div class="role">${role}</div>
            <div class="msg">${msg}</div>

            <div id="${carouselId}_box" class="mt-3"></div>
            <div id="${carouselId}_grid" class="gallery"></div>
        </div>`;

        if (folderId) {
            const images = await getImages(folderId);

            // Show featured image
            const featured = images.length ? images[0].url : "";
            document.getElementById(cardId).innerHTML =
                featured ? `<img src="${featured}" class="featured-img">` : "";

            // Carousel
            document.getElementById(`${carouselId}_box`).innerHTML = buildCarousel(images, carouselId);

            // Grid gallery
            const gridBox = document.getElementById(`${carouselId}_grid`);
            gridBox.innerHTML = images.map(img => 
                `<img src="${img.url}" alt="${img.name}" onclick="openImage('${img.url}')">`
            ).join("");
        }
    }
}

// IMAGE POPUP (fullscreen modal)
function openImage(url) {
    const w = window.open("");
    w.document.write(`<img src="${url}" style="width:100%">`);
}

// SEARCH FUNCTION
function filterCards() {
    let q = document.getElementById("search").value.toLowerCase();
    document.querySelectorAll(".person-card").forEach(card => {
        card.style.display = card.dataset.name.includes(q) ? "" : "none";
    });
}

loadAlbum();
</script>

</body>
</html>
