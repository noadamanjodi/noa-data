<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Farewell Album</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
    body {
        background: #eef4ff;
        padding: 25px;
        font-family: "Segoe UI", Arial, sans-serif;
    }
    h1 {
        text-align: center;
        font-size: 32px;
        margin-bottom: 10px;
        color: #003f88;
    }
    .subheading {
        text-align: center;
        font-size: 18px;
        color: #444;
        margin-bottom: 30px;
        margin-top: -5px;
    }
    .card {
        background: #ffffff;
        border-radius: 14px;
        padding: 22px;
        margin-bottom: 28px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    .name {
        font-size: 22px;
        font-weight: 600;
        text-align: center;
        margin-top: 15px;
        color: #003f88;
    }
    .role, .msg {
        text-align: center;
        font-size: 15px;
        margin-top: 4px;
        color: #444;
    }
    .carousel-inner img {
        height: 400px;
        width: 100%;
        object-fit: cover;
        border-radius: 10px;
        background: #eaeaea;
    }
    .loading {
        font-size: 14px;
        color: #777;
        padding: 10px 0;
        text-align: center;
    }
</style>
</head>

<body>

<h1>Farewell Album</h1>
<div class="subheading">Cherishing memorable moments and heartfelt send-offs for our esteemed officers</div>

<div id="albumContainer">Loading album...</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// === CONFIG ===
const SHEET_ID = "17fX959sLNO6mXrTqAdu0lVeGpzwwXZ9-FSicu24BgU0";
const SHEET_NAME = "web";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&tqx=out:json`;
const DRIVE_API_KEY = "AIzaSyBKZSium0piyKAQovFTOkePJ6-wdxkgaBM";
// ============================

// Extract folder ID
function getFolderId(url) {
    if (!url) return "";
    url = url.trim();

    let m = url.match(/\/folders\/([A-Za-z0-9_-]+)/);
    if (m) return m[1];

    m = url.match(/[?&]id=([A-Za-z0-9_-]+)/);
    if (m) return m[1];

    return "";
}

// Get images from Drive
async function getImages(folderId) {
    const q = encodeURIComponent(`'${folderId}' in parents and mimeType contains 'image/'`);
    const url = `https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name,mimeType)&key=${DRIVE_API_KEY}`;

    try {
        const resp = await fetch(url);
        const data = await resp.json();

        if (!data.files) return [];

        return data.files.map(f => ({
            id: f.id,
            url: `https://drive.google.com/thumbnail?id=${f.id}&sz=w2000`
        }));

    } catch (err) {
        console.error("Drive API error:", err);
        return [];
    }
}

// Build Carousel
function buildCarousel(images, cid) {
    if (images.length === 0) {
        return `<div class="loading">No photos found in folder.</div>`;
    }

    let slides = "";
    let indicators = "";

    images.forEach((img, i) => {
        slides += `
        <div class="carousel-item ${i === 0 ? "active" : ""}">
            <img src="${img.url}" alt="Photo">
        </div>`;

        indicators += `
        <button type="button" data-bs-target="#${cid}" data-bs-slide-to="${i}"
            class="${i===0?"active":""}"></button>`;
    });

    return `
    <div id="${cid}"
         class="carousel slide carousel-fade"
         data-bs-interval="2500"
         data-bs-ride="carousel"
         data-bs-pause="false"
         data-bs-touch="false"
         data-bs-wrap="true">

        <div class="carousel-indicators">${indicators}</div>
        <div class="carousel-inner">${slides}</div>

        <button class="carousel-control-prev" type="button" data-bs-target="#${cid}" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
        </button>

        <button class="carousel-control-next" type="button" data-bs-target="#${cid}" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
        </button>
    </div>`;
}

// ✅ Robust: activate even if some images fail OR are cached
function activateCarouselWhenReady(id) {
    const el = document.getElementById(id);
    if (!el) return;

    const imgs = el.querySelectorAll("img");
    if (imgs.length === 0) {
        // No images, still init to be safe
        new bootstrap.Carousel(el, {
            interval: 2500,
            ride: "carousel",
            pause: false
        });
        return;
    }

    let doneCount = 0;

    const markDone = () => {
        doneCount++;
        if (doneCount === imgs.length) {
            // All images either loaded or failed → start carousel
            new bootstrap.Carousel(el, {
                interval: 2500,
                ride: "carousel",
                pause: false
            });
        }
    };

    imgs.forEach(img => {
        // If already loaded from cache
        if (img.complete) {
            markDone();
        } else {
            img.onload = markDone;
            img.onerror = markDone; // even if error, still count
        }
    });
}

// Main Loader
async function loadAlbum() {
    const container = document.getElementById("albumContainer");

    const resp = await fetch(SHEET_URL);
    const text = await resp.text();
    const json = JSON.parse(text.substr(47).slice(0, -2));

    const rows = json.table.rows;
    container.innerHTML = "";

    for (let i = 0; i < rows.length; i++) {
        const r = rows[i];

        const name = r.c[1]?.v || "";
        const role = r.c[2]?.v || "";
        const msg  = r.c[3]?.v || "";
        const folderLink = r.c[4]?.v || "";

        const folderId = getFolderId(folderLink);
        const carouselId = `carousel_${i}`;

        container.innerHTML += `
        <div class="card">
            <div id="${carouselId}_box" class="mb-3">
                <div class="loading">Loading photos...</div>
            </div>

            <div class="name">${name}</div>
            <div class="role">${role}</div>
            <div class="msg">${msg}</div>
        </div>`;

        if (folderId) {
            const images = await getImages(folderId);

            document.getElementById(`${carouselId}_box`).innerHTML =
                buildCarousel(images, carouselId);

            // Start carousel when images are ready (or failed)
            activateCarouselWhenReady(carouselId);
        } else {
            document.getElementById(`${carouselId}_box`).innerHTML =
                `<div class="loading">No folder linked.</div>`;
        }
    }
}

loadAlbum();
</script>

</body>
</html>
