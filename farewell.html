<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Farewell Album</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
    body {
        background: #eef4ff;
        padding: 25px;
        font-family: "Segoe UI", Arial, sans-serif;
    }
    h1 {
        text-align: center;
        font-size: 32px;
        margin-bottom: 20px;
        color: #003f88;
    }
    #searchBox {
        width: 80%;
        max-width: 400px;
        margin: 0 auto 25px auto;
        display: block;
    }
    .card {
        background: #ffffff;
        border-radius: 14px;
        padding: 22px;
        margin-bottom: 28px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    .name {
        font-size: 24px;
        font-weight: 700;
        color: #003f88;
        text-align: center;
    }
    .role, .msg {
        text-align: center;
        font-size: 15px;
        color: #444;
    }
    .carousel-inner img {
        height: 420px;
        width: 100%;
        object-fit: cover;
        border-radius: 12px;
    }
    .grid {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
        justify-content: center;
    }
    .grid img {
        height: 110px;
        width: 150px;
        border-radius: 8px;
        cursor: pointer;
        object-fit: cover;
        transition: transform 0.2s;
    }
    .grid img:hover {
        transform: scale(1.05);
    }
</style>
</head>
<body>

<h1>Farewell Album</h1>

<input id="searchBox" type="text" class="form-control" placeholder="Search officer name..." />

<div id="albumContainer">Loading album...</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>

const SHEET_ID = "17fX959sLNO6mXrTqAdu0lVeGpzwwXZ9-FSicu24BgU0";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
const DRIVE_API_KEY = "AIzaSyBKZSium0piyKAQovFTOkePJ6-wdxkgaBM";

function getFolderId(url) {
    if (!url) return "";
    let m = url.match(/\/folders\/([A-Za-z0-9_-]+)/);
    if (m) return m[1];
    m = url.match(/[?&]id=([A-Za-z0-9_-]+)/);
    return m ? m[1] : "";
}

async function getImages(folderId) {
    const q = encodeURIComponent(`'${folderId}' in parents and mimeType contains 'image/'`);
    const url = `https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name)&key=${DRIVE_API_KEY}`;
    const resp = await fetch(url);
    const data = await resp.json();
    if (!data.files) return [];
    return data.files.map(f => ({
        id: f.id,
        url: `https://drive.google.com/uc?export=view&id=${f.id}`
    }));
}

function buildCarousel(images, cid) {
    if (images.length === 0) return "<p>No photos found.</p>";

    let slides = "";
    let indicators = "";

    images.forEach((img, i) => {
        slides += `
        <div class="carousel-item ${i === 0 ? "active" : ""}">
            <img src="${img.url}" class="d-block w-100">
        </div>`;
        indicators += `
        <button type="button" data-bs-target="#${cid}" data-bs-slide-to="${i}" class="${i===0?"active":""}"></button>`;
    });

    return `
    <div id="${cid}" class="carousel slide carousel-fade" data-bs-ride="carousel" data-bs-interval="3000">

        <div class="carousel-indicators">${indicators}</div>
        <div class="carousel-inner">${slides}</div>

        <button class="carousel-control-prev" type="button" data-bs-target="#${cid}" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
        </button>

        <button class="carousel-control-next" type="button" data-bs-target="#${cid}" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
        </button>
    </div>`;
}

async function loadAlbum() {
    const container = document.getElementById("albumContainer");

    const resp = await fetch(SHEET_URL);
    const text = await resp.text();
    const json = JSON.parse(text.substr(47).slice(0, -2));

    const rows = json.table.rows;
    container.innerHTML = "";

    for (let i = 1; i < rows.length; i++) {
        const r = rows[i];

        const name  = r.c[0]?.v || "";
        const role  = r.c[1]?.v || "";
        const msg   = r.c[2]?.v || "";
        const link  = r.c[3]?.v || "";
        const folderId = getFolderId(link);

        const carouselId = `carousel_${i}`;

        container.innerHTML += `
            <div class="card" data-name="${name.toLowerCase()}">
                <div class="name">${name}</div>
                <div class="role">${role}</div>
                <div class="msg">${msg}</div>

                <div id="${carouselId}_box" class="mt-3">Loading photos...</div>
                <div id="${carouselId}_grid" class="grid"></div>
            </div>`;
        
        if (folderId) {
            const images = await getImages(folderId);

            document.getElementById(`${carouselId}_box`).innerHTML =
                buildCarousel(images, carouselId);

            let gridHTML = "";
            images.forEach((img, index) => {
                gridHTML += `<img src="${img.url}" onclick="document.querySelector('#${carouselId}').carousel(${index})">`;
            });
            document.getElementById(`${carouselId}_grid`).innerHTML = gridHTML;
        }
    }
}

document.getElementById("searchBox").addEventListener("input", function () {
    const term = this.value.toLowerCase();
    document.querySelectorAll(".card").forEach(card => {
        card.style.display = card.dataset.name.includes(term) ? "" : "none";
    });
});

loadAlbum();

</script>

</body>
</html>
